<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header>
        <h1>PetCare</h1>
    </header>

    <main>
        <h2>ペットケア・マネジメントツール</h2>

        <!-- コンテンツ表示画面 -->
        <h3>診療明細書・検査結果・処方箋を管理します</h3>

        <form action="#" method="post"></form>
        <table class="form">
            <tr>
                <dl>
                    <td>
                        <dt class="form-title">ペットの名前：</dt>
                    </td>
                    <td>
                        <dd>
                            <select name="petname" id="petname">
                                <option value="">--- ペットの名前を選んでください ---</option>
                                <option value="lola">LOLA</option>
                                <option value="rocco">ROCCO</option>
                                <option value="lulu">LULU</option>
                                <option value="luke">LUKE</option>
                            </select>
                        </dd>
                    </td>
                </dl>
            </tr>

            <tr>
                <dl>
                    <td>
                        <dt class="form-title">通院日：</dt>
                    </td>
                    <td>
                        <dd>
                            <input type="date" id="num01">
                        </dd>
                    </td>
                </dl>
            </tr>

            <tr>
                <dl>
                    <td>
                        <dt class="form-title">動物病院：</dt>
                    </td>
                    <td>
                        <dd>
                            <input type="text" placeholder="動物病院を入力してください" id="vets">
                            <!-- <form action="http://www.google.co.jp/search" method="get">
                                <input type="hidden" name="hl" value="ja">
                                <input type="textbox" name="q" maxLength="255" size="30">
                                <input type="submit" name="btnG" value="Google 検索">
                            </form> -->

                        </dd>
                    </td>
                </dl>
            </tr>
        </table>

        <h3>画像をアップロードしてください</h3>

        <table class="button">
            <tr>
                <td><button id="selbtn">選択</button></td>
                <td><button id="upbtn">登録</button></td>
                <td><button id="downbtn">取得</button></td>
            </tr>
        </table>

        <table class="image">
            <tr>
                <td>
                    <dt>
                        <label>ファイル名：</label>
                    </dt>
                </td>
                <td>
                    <dd>
                        <input type="text" id="namebox" />
                        <label id="extlab"></label>
                    </dd>
                </td>
            </tr>
            <tr>
                <td>
                    <dt>
                        <label for="" id="upprogress"></label>
                    </dt>
                </td>
                <td>
                    <dd>
                        <img id="myimg" alt="" />
                    </dd>
                </td>
            </tr>


            <!-- <dl>
                <dt>
                    <label>ファイル名：</label>
                    <input type="text" id="namebox" />
                    <label id="extlab"></label>
                </dt>
                <dt>
                    <img id="myimg" alt="" />
                    <label for="" id="upprogress"></label>
                </dt>
            </dl> -->
        </table>
        <!--/ コンテンツ表示画面 -->
    </main>

    <footer>
        Copyrights Ulara Toma All Rights Reserved.
    </footer>

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module" src="js/firebase.js"></script>
    <!-- JQuery -->

    <!--** 以下Firebase **-->
    <!-- Firebaseからコピーする -->
    <!-- <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";

        // 別のサンプルファイルから以下のコードをコピペして追加する
        // import { getDatabase, ref, push, set, onChildAdded, remove,onChildRemoved } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCTbppzEfqKfymDzAwpzFFZy9x2e6ntlao",
          authDomain: "petcare-ea0e6.firebaseapp.com",
          projectId: "petcare-ea0e6",
          storageBucket: "petcare-ea0e6.appspot.com",
          messagingSenderId: "471803084638",
          appId: "1:471803084638:web:11e44a366158fd9d72d9cf"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // FirebaseのRealtime Databaseを使うための二行を記述する
        // const db = getDatabase(app);
        // const dbRef = ref(db, 'PetCare');


        import {
                getStorage,
                ref as sRef,
                uploadBytesResumable,
                getDownloadURL,
            } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-storage.js";

            import {
                getFirestore,
                doc,
                getDoc,
                setDoc,
                collection,
                addDoc,
            } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
            const clouddb = getFirestore();

            // -----------------------------------------------
            let files = [];
            let reader = new FileReader();

            let namebox = document.getElementById("namebox");
            let extlab = document.getElementById("extlab");
            let myimg = document.getElementById("myimg");
            let proglab = document.getElementById("upprogress");
            let SelBtn = document.getElementById("selbtn");
            let UpBtn = document.getElementById("upbtn");
            let DownBtn = document.getElementById("downbtn");

            let input = document.createElement("input");
            input.type = "file";

            console.log(input);
            input.onchange = (e) => {
                console.log(e);
                files = e.target.files;

                let extension = GetFileExt(files[0]);
                let name = GetFileName(files[0]);

                namebox.value = name;
                extlab.innerHTML = extension;

                reader.readAsDataURL(files[0]);
            };

            reader.onload = function () {
                myimg.src = reader.result;
            };

            // ----------selection--------------
            SelBtn.onclick = function () {
                console.log(1111);
                input.click();
            };

            function GetFileExt(file) {
                let temp = file.name.split(".");
                let ext = temp.slice(temp.length - 1, temp.length);
                return "." + ext[0];
            }

            function GetFileName(file) {
                let temp = file.name.split(".");
                let fname = temp.slice(0, -1).join(".");
                return fname;
            }

            // -------------upload-------------------------

            async function UploadProcess() {
                let ImgToUpload = files[0];

                let ImgName = namebox.value + extlab.innerHTML;

                const metaData = {
                    contentType: ImgToUpload.type,
                };
                const storage = getStorage();

                const storageRef = sRef(storage, "Images/" + ImgName);

                const UploadTask = uploadBytesResumable(
                    storageRef,
                    ImgToUpload,
                    metaData
                );

                UploadTask.on(
                    "state-changed",
                    (snapshot) => {
                        let progress =
                            (snapshot.bytesTransferred / snapshot.totalBytes) *
                            100;
                        proglab.innerHTML = "Upload " + progress + "%";
                        console.log(snapshot);
                    },
                    (error) => {
                        alert("エラーです！アップロードできてません！！");
                    },
                    () => {
                        getDownloadURL(UploadTask.snapshot.ref).then(
                            (downloadURL) => {
                                SaveURLtoFirestore(downloadURL);
                                console.log(downloadURL);
                            }
                        );
                    }
                );
            }
            // --------------------------- functions for firestore database---------------------------

            // 非同期処理
            async function SaveURLtoFirestore(url) {
                let name = namebox.value;
                let ext = extlab.innerHTML;

                let ref = doc(clouddb, "ImageLinks/" + name);

                await setDoc(ref, {
                    ImageName: name + ext,
                    ImageURL: url,
                });
            }

            async function GetImagefromFirestore() {
                let name = namebox.value;

                let ref = doc(clouddb, "ImageLinks/" + name);

                const docSnap = await getDoc(ref);

                if (docSnap.exists()) {
                    myimg.src = docSnap.data().ImageURL;
                }
            }

            UpBtn.onclick = UploadProcess;
            DownBtn.onclick = GetImagefromFirestore;





    </script> -->
</body>
</html>
